<!DOCTYPE html>
<html>
<head>
    <meta charset="utf-8" name="viewport" content="width=device-width, initial-scale=1.0" />
    <title></title>
    <script src="https://code.jquery.com/jquery-3.4.1.min.js"></script>
    <script src="../Scripts/ajaxCalls.js"></script>
    <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
    <script src="https://unpkg.com/sweetalert/dist/sweetalert.min.js"></script>
    <script src="../Scripts/FlightsAutoComplete.js"></script>
    <link href="../PagesCSS/Index.css" rel="stylesheet" />
    <link href="../PagesCSS/ResponsiveTable.css" rel="stylesheet" />
    <link href="../PagesCSS/AutoComplete.css" rel="stylesheet" />
    <!-- Add icon library -->
    <link rel="stylesheet" href="https://use.fontawesome.com/releases/v5.7.2/css/all.css" integrity="sha384-fnmOCqbTlWIlj8LyTjo7mOUStjsKC4pOpQbqyi7RrhN7udi9RwhKkMHpvLbHG9Sr" crossorigin="anonymous">


    <!--<link href="../PagesCSS/NavigationBar.css" rel="stylesheet" />-->
    <!--<link href="../PagesCSS/Test.css" rel="stylesheet" />-->
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/4.7.0/css/font-awesome.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/4.5.0/css/bootstrap.min.css">
    <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.5.1/jquery.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/popper.js/1.16.0/umd/popper.min.js"></script>
    <script src="https://maxcdn.bootstrapcdn.com/bootstrap/4.5.0/js/bootstrap.min.js"></script>

    <script>
        var dataForTable;
        var allAirportsData;
        var airportsNames;
        var tableType;
        var clickedOrderBtnIndex;
        var propertyFromApi = ["cityFrom", "cityTo", "route", "dTimeUTC", "aTimeUTC", "airlines", "price"];
        var headers = ["From", "To", "Stops", "DepartureTime", "ArrivalTime", "AirlineName", "Price", "Order"];
        //buttons function binding
        $(document).ready(function () {

            //First hide all the tables
            $("#NewOrderDiv").hide();
            $("#loadingGif").hide();

            // once the document is ready we fetch a list of Discounts from the server
            ajaxCall("GET", "../api/Discount", "", DiscountsSuccess, DiscountsError);

            // wire the submit event when client press save order
            $("#NewOrderForm").submit(onSubmit);

            //wire the submit event when client press search
            $("#flightForm").submit(getFlight);
            //wire the click event when client press myFlights
            $("#myFlightsBTN").click(getMyFlights);
            $("#switchBTN").click(switchInputs);

            //wire get airports button behavior
            $("#getAirportsBTN").click(function () {
                alert("getAirports was clicked,Please wait a few seconds until recieve a message");
                GetAirports();
                $(this).slideUp();
            });
            //set get airlines button behavior
            $("#getAirlinesBTN").click(function () {
                alert("getAirlines was clicked,Please wait a few seconds until recieve a message");
                GetAirlines();
                $(this).slideUp();
            });

            // wire the submit event when manager wish to login
            // $("#loginForm").submit(LoginCheck);

            //
            $("#cancelSaveBTN").click(function () {
                $("#NewOrderDiv").hide();
                $("#dynamicContent").show();
            });
        });
    

        var DiscountsFromManager;
        //Handling the discountsList we fetched from the database
        /////////////////////////////////////////////////////////////////////
        function DiscountsSuccess(DiscountsData) {
            //we'll use this to check if one of the flights is on sale
            DiscountsFromManager = DiscountsData;
        }

        function DiscountsError(err) {

            alert(err);
        }

        //Inserting Airlines to database
        ////////////////////////////////////////////////
        function GetAirlines() {
            getAllAirlines();
            return false; // the return false will prevent the form from being submitted
            // hence the page will not reload
        }
        function getAllAirlines() {

            let airlines = "https://api.skypicker.com/airlines";
            ajaxCall("GET", airlines, "", successAirline, errorAirline);
        }
        function successAirline(data) {
            AirlinesData = data;
            //  swal("Get Airlines json Success!", "", "success");
            AddAllAirline();
        }
        function errorAirline(err) {
            alert("error");
        }
        function AddAllAirline() {
            var AirlinesArr = [];
            for (var k in AirlinesData) {

                if (AirlinesData[k].type == 'airline') {
                    Airline = { // Note that the name of the fields must be identical to the names of the properties of the object in the server
                        airlineID: AirlinesData[k].id,
                        airlineName: AirlinesData[k].name,

                    };
                    AirlinesArr.push(Airline);
                }
            }
            ajaxCall("POST", "../api/Airlines", JSON.stringify(AirlinesArr), successPostAirline, errorPost);
        }


        function successPostAirline(data) {
            swal("Added Successfuly!", "Inserted all Airlines into Database", "success");
        }
        function errorPost(err) {
            alert("error");
        }

        //Inserting Airports to database
        function switchInputs() {
            let from = $("#originTB").val();
            let To = $("#destinationTB").val();

            $("#originTB").val(To);
            $("#destinationTB").val(from);
        }

        //Inserting Airports to database
        ///////////////////////////////////////////////////////////
        function GetAirports() {
            getAllAirports();
            return false; // the return false will prevent the form from being submitted
            // hence the page will not reload
        }


        function getAllAirports() {

            let airports = "https://api.skypicker.com/locations?type=dump&locale=en-US&location_types=airport&limit=4000&active_only=true&sort=name";
            ajaxCall("GET", airports, "", successAirports, errorAirports);
        }
        function successAirports(data) {
            AirportsData = data.locations;
            //  swal("Get Airports json Success!", "", "success");
            AddAllAirport();
        }
        function errorAirports(err) {
            alert("error");
        }

        function AddAllAirport() {
            var AirportsArr = [];
            for (var k in AirportsData) {

                Airport = { // Note that the name of the fields must be identical to the names of the properties of the object in the server
                    airportID: AirportsData[k].id,
                    airportName: AirportsData[k].name,
                    city: AirportsData[k].city.name,
                    country: AirportsData[k].city.country.name,
                    airportLong: AirportsData[k].location.lon,
                    airportLat: AirportsData[k].location.lat
                };
                AirportsArr.push(Airport);
            }
            ajaxCall("POST", "../api/Airports", JSON.stringify(AirportsArr), success, Error);
        }

        function success(data) {

            swal("Added Successfuly!", "Inserted all airports into Database", "success");
        }
        function Error(err) {
            console.log(err);
        }


        ///Airports AutoComplete Section
        ////////////////////////////////////////////////////

        function getAllAirportsAutoComplete() {

            let airports = "https://api.skypicker.com/locations?type=dump&locale=en-US&location_types=airport&limit=4000&active_only=true&sort=name";
            ajaxCall("GET", airports, "", successAP, errorAP);
        }
        function successAP(data) {
            allAirportsData = data;
            airportsNames = createAirportsList(data);

            /*initiate the autocomplete function on the "myInput" element, and pass along the countries array as possible autocomplete values:*/
            autocomplete(document.getElementById("originTB"), airportsNames);
            autocomplete(document.getElementById("destinationTB"), airportsNames);
        }
        function errorAP(err) {
            console.log(err.responseJSON.ExceptionMessage);
        }

        function createAirportsList(object) {
            var arr = [];
            for (var k in object.locations) {
                arr.push(object.locations[k].city.name + "(" + object.locations[k].id + ")");
            }
            return arr;
        }

        //get my flight list from server
        function getMyFlights() {
            tableType = 1;
            ajaxCall("GET", "../api/Flight", "", successCBF, errorCBF);
        }
        //clean search input
        function clearSearch() {
            $("#originTB").val("");
            $("#destinationTB").val("");
            $("#startDateTB").val();
            $("#endDateTB").val();
            $("#loadingGif").hide();

        }
        //GET (AjaxCall) from the skypicker api server using the values we input
        function getFlight() {

            $("#loadingGif").show();

            let originIndex = airportsNames.indexOf($("#originTB").val());
            let origin = allAirportsData.locations[originIndex].id;
            let destinationIndex = airportsNames.indexOf($("#destinationTB").val());
            let destination = allAirportsData.locations[destinationIndex].id;
            let start = convertDateType($("#startDateTB").val());
            let end = convertDateType($("#endDateTB").val());
            if (start > end) {
                alert("start date cant be bigger then end date");
                clearSearch();
                return false;
            }
            let api = "https://api.skypicker.com/flights?flyFrom=" + origin + "&to=" + destination + "&dateFrom=" + start + "&dateTo=" + end + "&partner=picky";
            tableType = 0;
            ajaxCall("GET", api, "", successCBF, errorCBF);
            return false;
        }

        function successCBF(data) {

            $("#loadingGif").hide();

            console.log(data);
            document.getElementById("dynamicContent").innerHTML = "";
            if (tableType == 0) {
                dataForTable = data.data;
                generateTable(0);
            }
            else {
                dataForTable = data;
                generateTable(1);
            }
        }

        function errorCBF(err) {
            console.log(err.responseJSON.ExceptionMessage);
        }


        function compare_dates(FlightDeparture, DiscountStart, DiscountEnd) {
            if (FlightDeparture > DiscountStart && FlightDeparture < DiscountEnd) return (true);
            else return (false);
        }

        function CheckIfOnSale(i) {

            if (typeof DiscountsFromManager == 'undefined') {

                let Flightindex = i;
                let DiscountStart = new Date(0);
                let DiscountEnd = new Date(0);
                let departure = new Date(0);
                let flightdata = dataForTable[Flightindex];
                departure.setUTCSeconds(flightdata.dTimeUTC);
                let FlightDeparture = departure.toISOString();

                for (var j = 0; j < DiscountsFromManager.length; j++) {

                    DiscountStart = (DiscountsFromManager[j].DiscountStart);
                    DiscountEnd = (DiscountsFromManager[j].DiscountEnd);

                    if (flightdata.cityCodeFrom == DiscountsFromManager[j].From && flightdata.airlines[0] == DiscountsFromManager[j].AirlineName && compare_dates(FlightDeparture, DiscountStart, DiscountEnd)) {
                        return true;
                    }
                }
                return false;
            } else {
                return false;
            }
        }

        //Dynamically create a table and render the search results we have.
        //parameter type will determine the table content, 0 for API results ,1 for results from server
        function generateTable(type) {

            var tableArea = document.getElementById("dynamicContent");
            var tableTitle = document.createElement('p');
            tableTitle.setAttribute("id", "tableTitle")
            //create new table element
            var table = document.createElement('table');
            table.setAttribute("id", "flightTbl");// set table id to - flightTbl
            var limit;
            var handler;
            var OnSale;

            if (type == 0)//generate search flight table
            {
                limit = headers.length;
                handler = propertyFromApi;
                //Decide how many rows you want to see
                for (var i = 0; i < dataForTable.length; i++) {    ///dataForTable.length
                    var row = document.createElement('tr');

                    OnSale = CheckIfOnSale(i);

                    for (var j = 0; j < limit; j++) {
                        row.appendChild(document.createElement('td'));//Add column to the row
                        //Check (j==7) if we are at the "order" feature so we can add a button.

                        if (j == 7) {
                            row.cells[j].appendChild(getDataForApiTable(i, headers[j], OnSale));
                        }
                        else {
                            row.cells[j].appendChild(document.createTextNode(getDataForApiTable(i, handler[j], OnSale)));

                            if (j == 6 && OnSale) {
                                row.cells[j].style.color = "Red";

                            }
                        }
                    }
                    table.appendChild(row);
                    Onsale = false;
                }
                tableTitle.innerText = "Search Results - ";
                tableArea.appendChild(tableTitle);
                tableArea.appendChild(table);
                setTablesHeaders(headers.length, table.id);
            }
            else // generate my flight table
            {
                limit = propertyFromApi.length;
                handler = headers;
                for (var i = 0; i < dataForTable.length; i++) {    ///dataForTable.length
                    var row = document.createElement('tr');
                    for (var j = 0; j < limit; j++) {
                        row.appendChild(document.createElement('td'));//Add column to the row
                        row.cells[j].appendChild(document.createTextNode(dataForTable[i][handler[j]]));
                    }
                    table.appendChild(row);
                }
                tableTitle.innerText = "My Flights List - ";
                tableArea.appendChild(tableTitle);
                tableArea.appendChild(table);
                setTablesHeaders(propertyFromApi.length, table.id);
            }
        }

        //extract relevant data for search table from api object
        function getDataForApiTable(set, feature, OnSale) {

            if (feature == "cityFrom")//Origin
            {
                return dataForTable[set][feature];
            }
            if (feature == "cityTo")//Destination
            {
                return dataForTable[set][feature];
            }
            if (feature == "route")//num of stops
            {
                let temp = dataForTable[set][feature];
                let stringToReturn = "";
                for (var k in temp) {
                    stringToReturn += (temp[k].cityTo + ",");
                }
                return stringToReturn;
            }
            if (feature == "dTimeUTC")//Departure Time
            {

                let dep = new Date(0);//
                dep.setUTCSeconds(dataForTable[set][feature]);
                return dep.toUTCString();
            }
            if (feature == "aTimeUTC")//Arrival Time
            {
                let Arv = new Date(0);
                Arv.setUTCSeconds(dataForTable[set][feature]);
                return Arv.toUTCString();
            }
            if (feature == "airlines")//AirLine Name
            {
                return dataForTable[set][feature][0];
            }
            if (feature == "price")//Price
            {
                if (OnSale) {

                    return dataForTable[set][feature] + "EUR, Sale!!!";
                }

                return dataForTable[set][feature] + " EUR";
            }

            if (feature == "Order") {
                let btn = document.createElement("button");
                btn.setAttribute("id", "tableBtn" + (set + 1));
                //btn.setAttribute("name", "Order Row " + (set+1));
                btn.innerHTML = "Order Row " + (set + 1);
                btn.onclick = function () {
                    // postFlight(this);
                    InsertFlight(this);
                };
                return btn
            }
        }

        // extract the index from clicked orderBtn and show order form
        function InsertFlight(btnClicked) {
            let index = btnClicked.id;
            index = index.replace(/\D/g, '');
            index = parseInt(index);
            index--;
            clickedOrderBtnIndex = index;
            //clearFields();
            $("#dynamicContent").hide();
            $("#NewOrderDiv").show();


        }
        // clear the form fields
        function clearFields() {
            $("#ClientName").val("");
            $("#EMail").val("");

        }
        // add new order to data base when clicking savebtn at order form
        function onSubmit() {
            let timeOfOrder = new Date(Date.now());
            NowDate = timeOfOrder.toISOString();
            let flightID = dataForTable[clickedOrderBtnIndex].id;
            let airportFrom = dataForTable[clickedOrderBtnIndex].flyFrom;
            let airportTo = dataForTable[clickedOrderBtnIndex].flyTo;
            let price = dataForTable[clickedOrderBtnIndex].price;
            let duration = dataForTable[clickedOrderBtnIndex].fly_duration;
            let departure = new Date(0);
            let arrival = new Date(0);
            let legs = dataForTable[clickedOrderBtnIndex]['route'];
            let legsFinal = [];
            departure.setUTCSeconds(dataForTable[clickedOrderBtnIndex].dTimeUTC);
            arrival.setUTCSeconds(dataForTable[clickedOrderBtnIndex].aTimeUTC);

            //creating leg object and pushing it to the array
            for (var i = 0; i < legs.length; i++) {
                let Departure = new Date(0);
                let Arrival = new Date(0);
                Departure.setUTCSeconds(legs[i].dTimeUTC);
                Arrival.setUTCSeconds(legs[i].aTimeUTC);
                let timeDiff = Arrival.getTime() - Departure.getTime(); //timediff contains num of milliseconds
                let seconds = parseInt((timeDiff / 1000) % 60);
                let minutes = parseInt(((timeDiff / (1000 * 60)) % 60));
                let hours = parseInt(((timeDiff / (1000 * 60 * 60)) % 24));
                let Duration = hours + "h " + minutes + "m";
                legObject = {

                    LegID: legs[i].id,
                    FlightID: flightID,
                    AirlineID: legs[i].airline,
                    AirportFrom: legs[i].flyFrom,
                    AirportTo: legs[i].flyTo,
                    Flight_no: legs[i].flight_no,
                    LegNum: i,
                    Departure: Departure,
                    Arrival: Arrival,
                    Duration: Duration
                }
                legsFinal.push(legObject);
            }

            OrderObject = {
                orderID: 0,
                ClientName: $("#ClientName").val(),
                Email: $("#EMail").val(),
                FlightID: flightID,
                TimeOfOrder: NowDate,
                AirlineID: legs[0].airline,
                airportFrom: airportFrom,
                airportTo: airportTo,
                price: price,
                duration: duration,
                departure: departure,
                arrival: arrival,
                legs: legsFinal
            }


            ajaxCall("POST", "../api/Flights", JSON.stringify(OrderObject), successFlight, ErrorFlight);

            return false;
        }
        //success and error behavior
        function successFlight(data) {
            $("#NewOrderDiv").hide();
            //swal("Added Successfuly!", "Inserted Flight into Database", "success");
            swal({ // this will open a dialouge
                title: "Success",
                text: "Inserted Flight into Database",
                icon: "success",
                confirm: true,

            })
                .then(function (BtnClicked) {
                    if (BtnClicked) window.location.reload();
                    else window.location.reload();
                });

        }
        function ErrorFlight(err) {
            console.log(err);
            alrert(err);
        }




        //sets the header table after creation
        function setTablesHeaders(value, tableId) {
            var table = document.getElementById(tableId)
            //creat new row an add it to the begin of table
            var row = table.insertRow(0);
            for (var i = 0; i < value; i++) {
                var cell = document.createElement('th');
                cell.innerHTML = headers[i];
                row.appendChild(cell);
            }
        }

        //conver date type to fit api search request
        function convertDateType(toConvert) {
            var temp = toConvert.split("-");
            var year = temp[0];
            var month = temp[1];
            var day = temp[2];
            return (day + "/" + month + "/" + year);
        }

        //save selected flight in server
        function postFlight(btn) {

            let index = btn.id;
            index = index.replace(/\D/g, '');
            let FlightTable = document.getElementById("flightTbl");
            index = parseInt(index);

            let from = FlightTable.rows[index].cells[0].innerHTML;
            let to = FlightTable.rows[index].cells[1].innerHTML;
            let stopsStr = FlightTable.rows[index].cells[2].innerHTML;
            let stops = stopsStr.split(',');
            let departuretime = FlightTable.rows[index].cells[3].innerHTML;
            let arrivaltime = FlightTable.rows[index].cells[4].innerHTML;
            let airlinename = FlightTable.rows[index].cells[5].innerHTML;
            let price = FlightTable.rows[index].cells[6].innerHTML;

            o = {
                // critical point, zillion error here
                // parameters passing is done by names
                // must be identical to the class Properties
                From: from,
                To: to,
                Stops: stops,
                DepartureTime: departuretime,
                ArrivalTime: arrivaltime,
                AirlineName: airlinename,
                Price: price,
            }
            ajaxCall("POST", "../api/Flight", JSON.stringify(o), postSuccessCB, postErrorCB);
        }

        function postSuccessCB(data) {

            if (data) {
                alert("Post successful")
            }
            else {
                alert("You already ordered that! :)");
            }
        }
        function postErrorCB(err) {
            alert(err.responseJSON.ExceptionMessage);
        }
    </script>

</head>

<!--Class bg is for the background image-->
<body onload="getAllAirportsAutoComplete()" class="bg">


    <!--/////////////////////NEW Logo\Header\\\\\\\\\\\\\\\\\\\\\\\-->

    <!--/////////////////////END Logo\Header\\\\\\\\\\\\\\\\\\\\\\\-->

    <!--/////////////////////START NEW SEARCH\\\\\\\\\\\\\\\\\\\\\\-->
    <div class="container">
        <form autocomplete="off" action="/action_page.php" id="flightForm">
            <div class="form-row justify-content-md-center">

                <div class="form-group col-md-5 autocomplete">
                    <!--We must add autocomplete-->
                    <label for="origin" class="MainLabel">From</label>
                    <input type="text" class="form-control" id="originTB" name="myOrigin" placeholder="From" required>
                </div>
                <div class="form-group col-md-2 text-center">
                    <!--We must add autocomplete-->
                    <label style="width:100%; min-height:18px;"></label>
                    <button style="width:100px" type="button" class="btn btn-primary" id="switchBTN"><i class="fas fa-exchange-alt" style="font-size:20px;"></i></button>
                </div>
                <div class="form-group col-md-5 autocomplete">
                    <label for="destination" class="MainLabel">To:</label>
                    <input type="text" class="form-control" id="destinationTB" name="myDestination" placeholder="To" required />
                </div>
            </div>
            <div class="form-row justify-content-md-center">

                <div class="form-group col-md-5">
                    <label for="sDate" class="MainLabel">Depart</label>
                    <input type="date" class="form-control" id="startDateTB" name="myStartDate" dateva required />
                </div>

                <div class="form-group col-md-5 offset-md-2">
                    <!--We need offset to create an empty space in the middle-->
                    <label for="eDate" class="MainLabel">Return</label>
                    <input type="date" class="form-control" id="endDateTB" name="myEndDate" required />
                </div>
            </div>
            <div class="form-row">
                <div class="col-md-3">
                    <button type="submit" class="btn btn-primary" id="searchBTN" style="font-size:x-large">Search Flights</button>
                </div>
                <div class="col-md-3">
                    <input type="checkbox" id="NonStop" name="nonStop">
                    <label for="vehicle1">Non-stop flights only</label>
                </div>
            </div>
        </form>
    </div>

    <!--///////////////////////////END NEW SEARCH\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\-->
    <!--We will be adding an uploadingGif for cool affects-->
    <div id="loadingGif" class="text-center" style="display:none;">
        <img src="../Images/PlaneGif4.gif" style="width:400px; height:300px;" />
    </div>

    
    <!--For the dynamic content [Tables]-->
    <div id="dynamicContent">

    </div>


    <!--Hidden form, show only when the client is done choosing a flight-->
    <div id="NewOrderDiv" style="display:none;">
        <form id="NewOrderForm">
            <div class="form-group row">
                <div class="form-group col-sm-4">
                    <label for="ClientName"><span class="red-star">★ </span>ClientName</label>
                    <input type="text" class="form-control" id="ClientName" placeholder="Enter full name" required>
                </div>
                <div class="form-group col-sm-4">
                    <label for="EMail"><span class="red-star">★ </span>E- Mail</label>
                    <input type="text" class="form-control" id="EMail" placeholder="Enter E-Mail" required>
                </div>
                <div class="form-group col-sm-4">
                    <label for="Agree to Terms"><span class="red-star">★ </span>Agree to Terms:</label>
                    <input type="checkbox" class="form-control" id="Agree" required>
                </div>
            </div>
            <button type="submit" class="btn btn-primary btn-lg" id="saveBTN">Save</button>
            <input type="button" class="btn btn-warning btn-lg" id="cancelSaveBTN" value="Cancel" />
        </form>
    </div>
</body>
</html>