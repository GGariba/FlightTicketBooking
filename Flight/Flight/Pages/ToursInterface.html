<!DOCTYPE html>
<html>
<head>
    <meta charset="utf-8" />
    <title>Manager API</title>
    <!--<link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.7/css/bootstrap.min.css">-->
    <link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/4.5.0/css/bootstrap.min.css">
    <script src="https://code.jquery.com/jquery-3.5.1.js"></script>
    <!--<script type="text/javascript" src="https://code.jquery.com/jquery-3.3.1.js"></script>-->

    <link rel="stylesheet" type="text/css" href="https://cdn.datatables.net/1.10.21/css/jquery.dataTables.min.css">
    <link rel="stylesheet" type="text/css" href="https://cdn.datatables.net/1.10.21/css/dataTables.bootstrap.min.css">
    <link rel="stylesheet" type="text/css" href="https://cdn.datatables.net/rowreorder/1.2.7/css/rowReorder.dataTables.min.css">
    <link rel="stylesheet" type="text/css" href="https://cdn.datatables.net/responsive/2.2.5/css/responsive.dataTables.min.css">
    <script src="../Scripts/ajaxCalls.js"></script>
    <!--<script src="../Scripts/AjaxCallsToursStubjs.js"></script>-->
    <script src="../Scripts/FlightsAutoComplete.js"></script>
    <link href="../PagesCSS/AutoComplete.css" rel="stylesheet" />
    <link href="../PagesCSS/ManagerInterface.css" rel="stylesheet" />
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/4.7.0/css/font-awesome.min.css" rel="stylesheet">

    <script src="https://unpkg.com/sweetalert/dist/sweetalert.min.js"></script>
    <script src="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.7/js/bootstrap.min.js"></script>
    <!-- <script src="https://ajax.googleapis.com/a  jax/libs/jquery/3.3.1/jquery.min.js"></script>-->
    <script src=" https://cdn.datatables.net/1.10.21/js/jquery.dataTables.min.js"></script>
    <script src=" https://cdn.datatables.net/1.10.21/js/dataTables.bootstrap.min.js"></script>
    <script src="https://cdn.datatables.net/responsive/2.2.5/js/dataTables.responsive.min.js"></script>
    <script src=" https://cdn.datatables.net/responsive/2.2.5/js/responsive.bootstrap.min.js"></script>
    <script src="https://cdn.datatables.net/fixedheader/3.1.7/js/dataTables.fixedHeader.min.js"></script>



    
    <script>
        var AlreadyCalledDiscount = 0;
        var AlreadyCalledOrders = 0;
        var apiCounter = 0;
        var EatingOut = "", SightSeeing = "", ToursData = "";
        var CityTour = "";
        var ToursArr = [];

        var allAirportsData, airportsNames;
        // will run when the document is ready
        $(document).ready(function () {

            //Name of manager that logged in is shown in nav bar.
            var man = JSON.parse(localStorage.getItem('man'));
            document.getElementById("man").innerHTML = man.username;
            mode = "";

            //wire the submit event when Manager press search
            $("#SearchForm").submit(getTours);
            $("#ToursFormEDIT").submit(InsertToDatabase);
            
            $("#newBTN").on("click", function () {
                $("#ToursForm").hide();
                tour = null;
                mode = "new";
                $("#SearchForm").show();
            });

            $("#cancelSaveBTN").on("click", function () {
                tour = null;
                $("#editDiv").hide();
                if (mode == "new") $("#ToursForm").show();
                mode = "";
            });



        });
        //Insert selected Tour to DataBase
        function InsertToDatabase() {

         
        }

        //GET (AjaxCall) from the skypicker api server using the values we input
        function getTours() {

            let destination = $("#CitySearch").val();
            CityTour = destination;
            destination = destination.replace(/ /g, "_");


            let apiEatingOut = "https://www.triposo.com/api/20200405/poi.json?location_id=" + destination + "&tag_labels=eatingout&count=10&fields=id,name,score,intro,tag_labels&account=EB9YW8BZ&token=ve18dbyy61vqg2gzzwsj2nyn6yejer8j"
            let apiSightseeing = "https://www.triposo.com/api/20200405/poi.json?location_id=" + destination + "&tag_labels=sightseeing&fields=id,name,score,intro,tag_labels&account=EB9YW8BZ&token=ve18dbyy61vqg2gzzwsj2nyn6yejer8j"
            let apiTours = "https://www.triposo.com/api/20200405/tour.json?location_ids=" + destination + "&count=10&fields=id,name,score,price,intro,tag_labels&account=EB9YW8BZ&token=ve18dbyy61vqg2gzzwsj2nyn6yejer8j";

            $.get(apiTours).done(successTours);
            $.get(apiTours).fail(errorCBF);
            $.get(apiSightseeing).done(successSight);
            $.get(apiSightseeing).fail(errorCBF);
            $.get(apiEatingOut).done(successEating);
            $.get(apiEatingOut).fail(errorCBF);
            return false;
        }
      
        // this function is activated in case of a failure
        function errorCBF(err) {
            swal("Error: " + err);
        }

        function successEating(eating) {
             
            EatingOut = eating;
            apiCounter++;
            if (apiCounter == 3) {
                PrepareJson();
            }
        }

        function successSight(sight) {

            SightSeeing = sight;
            apiCounter++;
            if (apiCounter == 3) {
                PrepareJson();
            }
        }

        function successTours(tours) {

            ToursData = tours;
            apiCounter++;

            if (apiCounter == 3) {
                PrepareJson();
            }
        }


        function PrepareJson() {

            $("#SearchForm").hide();

            JsonLoop(ToursData.results,"Tour");
            JsonLoop(SightSeeing.results,"SightSeeing");
            JsonLoop(EatingOut.results,"EatingOut");      
            buildTable(ToursArr);            
        }

        function JsonLoop(JsonData,Mode) {
            console.log(JsonData);

            if (Mode == "EatingOut" || Mode=="SightSeeing") {

                for (var k in JsonData) {
                    eating = {
                        TourID: JsonData[k].id,
                        Name: JsonData[k].name,
                        Score: JsonData[k].score,
                        Price: "0",
                        Intro: JsonData[k].intro,
                        City: CityTour,
                    };
                    ToursArr.push(eating);
                }
            }
            else {
                for (var k in JsonData) {
                    Tour = {
                        TourID: JsonData[k].id,
                        Name: JsonData[k].name,
                        Score: JsonData[k].score,
                        Price: JsonData[k].price.amount,
                        Intro: JsonData[k].intro,
                        City: CityTour,
                    };
                    ToursArr.push(Tour);
                }
            }           
        }

        // SuccessFunction - Build a TourTable based on 
        function buildTable(Data) {
            NewTours = Data; // 

            try {
                tbl = $('#ToursTable').DataTable({
                    data: NewTours,
                    responsive: true,
                    columns: [
                        {
                            render: function (data, type, row, meta) {
                                let dataTours = "data-tourId='" + row.TourID + "'";

                                editBtn = "<button type='button' class = 'editBtn btn btn-success' " + dataTours + "> Edit </button>";
                                viewBtn = "<button type='button' class = 'viewBtn btn btn-info' " + dataTours + "> View </button>";
                                return editBtn + viewBtn;
                            },

                            data: null,
                            className: "details-control"
                        },
                        { data: "Name" },
                        { data: "Score" },
                        { data: "Price" },
                        { data: "Intro" },

                    ]
                });
                //new $.fn.dataTable.FixedHeader(tbl);
                buttonEvents();
                $("#ToursForm").show();
            }
            catch (err) {
                alert(err);
            }

        }

        // this function is activated in case of a failure
        function DisError(err) {
            swal("Error: " + err);
        }
        // wire all the buttons to their functions
        function buttonEvents() {

            $(document).on("click", ".editBtn", function () {
                mode = "edit";
                markSelected(this);
                $("#editDiv").show();
                $("#editDiv :input").prop("disabled", false); // edit mode: enable all controls in the form
                populateFields(this.getAttribute('data-tourId')); // fill the form fields according to the selected row
            });

            $(document).on("click", ".viewBtn", function () {
                mode = "view";
                markSelected(this);
                $("#editDiv").show();
                row.className = 'selected';
                $("#editDiv :input").attr("disabled", "disabled"); // view mode: disable all controls in the form
                $("#Image").attr("disabled", false);
                $("#Currency").attr("disabled", false);
                $("#Category").attr("disabled", false);
                $("#Duration").attr("disabled", false);
                $("#Transportaion").attr("disabled", false);
                $("#saveBTN").attr("disabled", false);
                $("#cancelSaveBTN").attr("disabled", false);

                populateFields(this.getAttribute('data-tourId'));
            });
      
        }

        // mark the selected row
        function markSelected(btn) {
            $("#ToursTable tr").removeClass("selected"); // remove seleced class from rows that were selected before
            row = (btn.parentNode).parentNode; // button is in TD which is in Row
            row.className = 'selected'; // mark as selected
        }


        // fill the form fields
        function populateFields(TourID) {
            tour = getTourID(TourID);
            $("#Name").val(tour.Name);
            $("#Score").val(tour.Score);
            $("#Price").val(tour.Price);
            $("#Intro").val(tour.Intro);

        }

        // get a car according to its Id
        function getTourID(id) {
            for (i in NewTours) {
                if (NewTours[i].TourID == id)
                    return NewTours[i];
            }
            return null;
        }


        ///Airports AutoComplete Section
        ////////////////////////////////////////////////////

        function getAllAirportsAutoComplete() {

            let airports = "https://api.skypicker.com/locations?type=dump&locale=en-US&location_types=airport&limit=4000&active_only=true&sort=name";
            ajaxCall("GET", airports, "", successAP, errorAP);
        }
        function successAP(data) {
            allAirportsData = data;
            airportsNames = createAirportsList(data);

            /*initiate the autocomplete function on the "myInput" element, and pass along the countries array as possible autocomplete values:*/
            autocomplete(document.getElementById("CitySearch"), airportsNames);
        }
        function errorAP(err) {
            console.log(err.responseJSON.ExceptionMessage);
        }
        function createAirportsList(object) {
            var arr = [];
            for (var k in object.locations) {
                if (!arr.includes(object.locations[k].city.name))
                    arr.push(object.locations[k].city.name);
            }
            return arr;
        }
    </script>
</head>
<body onload="getAllAirportsAutoComplete()" class="bg">

    <!------------------Navigation Bar-------------->
    <nav class="navbar navbar-expand-md navbar-dark bg-dark ">
        <div class="container">
            <div class="row justify-content-sm-center">
                <div class="col-sm-2">
                    <a class="navbar-brand" href="index.html"><label style="text-decoration: underline overline;">HomePage</label></a>
                </div>
                <div class="col-sm-2 offset-sm-2">
                    <label id="man" style="color:white">""</label>
                </div>
                <div class="col-sm-6">
                    <label style="color:white">Welcome to ToursInterface</label>
                </div>
            </div>
        </div>
    </nav>
    <!-----------------End Navigation Bar------------->



    <div class="container">
        <div class="row">
            <div class="col-md-6 text-center">
                <input type="button" value="Add a New Tour" class="MainBTN" id="newBTN" />
            </div>
            <div class="col-md-6 text-center">
                <button type="button" class="MainBTN" id="GetToursBTN">Get Tours</button>
            </div>
        </div>


        <!--Make sure the form has the autocomplete function switched off:-->
        <form autocomplete="off" action="/action_page.php" id="SearchForm" style="display:none">
            <div class="form-row justify-content-md-center">
                <div class="form-group col-md-5 autocomplete">
                    <!--We must add autocomplete-->
                    <label for="origin" class="MainLabel">City</label>
                    <input type="text" class="form-control" id="CitySearch" name="myOrigin" placeholder="From" required>
                </div>
                <div class="col-md-3 col-xs-offset-2">
                    <label style="width:100%; min-height:18px;"></label>
                    <button type="submit" class="btn btn-primary" id="searchBTN" style="font-size:large">Search Cities</button>
                </div>
            </div>
        </form>
    </div>

    <form id="ToursForm" style="display:none;">
        <table id="ToursTable"  class="display center" style="width:90%;">
            <thead>
                <tr>
                    <th></th>
                    <th>Name</th>
                    <th>Score</th>
                    <th>Price</th>
                    <th>Intro</th>
                </tr>
            </thead>
        </table>
    </form>


    <!---//////////////////////////////////////////////////////////////////////////////-->


    <div id="editDiv" style="display:none">
        <form id="ToursFormEDIT" style="width:90%">
            <div class="form-group row">
                <div class="form-group col-sm-3">
                    <label for="Name"><span class="red-star">★ </span>Name</label>
                    <input type="text" class="form-control" id="Name" required>
                </div>
                <div class="form-group col-sm-3">
                    <label for="Score"><span class="red-star">★ </span>Score</label>
                    <input type="text" class="form-control" id="Score" required>
                </div>
                <div class="form-group col-sm-3">
                    <label for="Price"><span class="red-star">★ </span>Price</label>
                    <input type="text" class="form-control" id="Price" required>
                </div>
                <div class="form-group col-sm-3">
                    <label for="Currency"><span class="red-star">★ </span>Currency</label>
                    <input type="text" class="form-control" id="Currency" placeholder="Enter Currency to Save" required>
                </div>

            </div>

            <div class="form-group row">
                <div class="form-group col-sm-4">
                    <label for="Intro"><span class="red-star">★ </span>Intro</label>
                    <textarea id="Intro" class="form-control" rows="5" cols="50" disabled required>  </textarea>
                </div>
                <div class="form-group col-sm-2 ">
                    <label for="Category"><span class="red-star">★ </span>Category</label>
                    <input type="text" class="form-control" id="Category" placeholder="Enter Category to save" required>
                </div>
                <div class="form-group col-sm-2 ">
                    <label for="Duration"><span class="red-star">★ </span>Duration</label>
                    <input type="text" class="form-control" id="Duration" placeholder="Enter Duration to save" required>
                </div>
                <div class="form-group col-sm-3 ">
                    <label for="Image"><span class="red-star">★ </span>Image{URL}</label>
                    <input type="text" class="form-control" id="Image" placeholder="Enter Image URL to save" required>
                </div>
                <div class="form-group col-sm-1 ">
                    <label for="Transportaion"><span class="red-star">★ </span>Transportaion?</label>
                    <input type="checkbox" class="form-control" id="Transportaion" placeholder="Enter Transportaion URL to save" required>
                </div>
            </div>

            <button type="submit" class="btn btn-primary btn-lg" id="saveBTN">Save</button>
            <input type="button" class="btn btn-warning btn-lg" id="cancelSaveBTN" value="Cancel" />
        </form>
    </div>
</body>
</html>